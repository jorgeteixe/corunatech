---
import EventCard from './EventCard.astro'
import { getCollection } from 'astro:content'
import '../styles/components/Events.css'

// Get all events and communities
const allEvents = await getCollection('events')
const communities = await getCollection('communities')
const communityMap = new Map(communities.map(c => [c.id, c.data.name]))

// Current date for comparison (build time)
const now = new Date()

// Filter events into future and past
const futureEvents = allEvents
  .filter(event => event.data.date >= now)
  .sort((a, b) => a.data.date.getTime() - b.data.date.getTime())

const pastEvents = allEvents
  .filter(event => event.data.date < now)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
---

<section class="events-section">
  <div class="events-container">
    <!-- Future Events -->
    <div class="events-group">
      <h2 class="events-title">Próximos Eventos</h2>
      {
        futureEvents.length > 0 ? (
          <div class="events-grid">
            {futureEvents.map(event => (
              <EventCard
                {...event.data}
                slug={event.id}
                communityName={communityMap.get(event.data.community)}
              />
            ))}
          </div>
        ) : (
          <div class="events-empty">
            <p class="events-empty-text">
              Non hai eventos próximos programados.
            </p>
          </div>
        )
      }
    </div>

    <!-- Past Events -->
    <div>
      <h2 class="events-title">Eventos Pasados</h2>
      {
        pastEvents.length > 0 ? (
          <div class="events-grid past-events">
            {pastEvents.map(event => {
              // Omitir rsvpLink para eventos pasados
              const { rsvpLink, ...eventDataWithoutRSVP } = event.data
              return (
                <EventCard
                  {...eventDataWithoutRSVP}
                  slug={event.id}
                  communityName={communityMap.get(event.data.community)}
                />
              )
            })}
          </div>
        ) : (
          <div class="events-empty">
            <p class="events-empty-text">
              Non hai eventos pasados rexistrados.
            </p>
          </div>
        )
      }
    </div>
  </div>
</section>
